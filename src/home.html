<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Vinit Shahdeo" />
    <link
      href="http://www.jqueryscript.net/css/jquerysctipttop.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat"
      rel="stylesheet"
    />
    <title>Water Level Monitoring System - IoT Project</title>
    <style>
      body {
        background-color: #fafafa;
        font-family: "Montserrat", sans-serif;
      }

      .container {
        margin: 80px auto;
        max-width: 960px;
      }

      .demo {
        padding: 20px;
        margin: 30px;
      }

      h1 {
        text-align: center;
        color: #fff;
      }

      .title {
        color: grey;
      }

      h2 {
        padding-top: 200px;
        text-align: center;
        font-weight: 800;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <center>
        <h1 class="title">Water Monitoring System</h1>
        <p>
          Water Monitoring System is an IOT based Liquid Level Monitoring system
          that has mechanisms to keep the user alerted in case of liquid
          overflow or when tank depletes.
        </p>
      </center>
      <div class="row">
        <div class="col-lg-3">
          <div
            class="tank1"
            style="width: 200px;height:200px; float:left"
          ></div>
          <h2>Tank 1</h2>
        </div>
        <div class="col-lg-3">
          <div
            class="tank2"
            style="width: 200px;height:200px; float:left"
          ></div>
          <h2>Tank 2</h2>
        </div>
        <div class="col-lg-3">
          <div
            class="tank3"
            style="width: 200px;height:200px; float:left"
          ></div>
          <h2>Tank 3</h2>
        </div>
        <div class="col-lg-3">
          <div
            class="tank4"
            style="width: 200px;height:200px; float:left"
          ></div>
          <h2>Tank 4</h2>
        </div>
      </div>
    </div>

    <!-- Alarm controls -->
    <div class="container">
      <div class="row" style="margin-top:18px; align-items:center;">
        <div class="col-lg-8">
          <label for="alarmThreshold" style="display:block; margin-bottom:6px; font-weight:600;">Alarm threshold</label>
          <div style="display:flex; align-items:center; gap:12px;">
            <input id="alarmThreshold" type="range" min="50" max="100" value="95" style="flex:1;" />
            <div id="alarmThresholdValue" style="width:64px; text-align:center; font-weight:700;">95%</div>
          </div>
          <small class="text-muted">Move the slider to set when the alarm should trigger.</small>
        </div>
        <div class="col-lg-4" style="display:flex; align-items:flex-end;">
          <button id="stopAlarm" class="btn btn-danger" style="width:100%;">Stop Alarm</button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div
          class="col-lg-4"
          style="background-color: #fe5e21;min-height: 100px;min-width: 100px; "
        >
          <h1>Danger Zone</h1>
        </div>
        <div
          class="col-lg-4"
          style="background-color: #ffb30c;min-width: 100px;min-height: 100px"
        >
          <h1>Warning Zone</h1>
        </div>
        <div
          class="col-lg-4"
          style="background-color: #2ed351;min-width: 100px;min-height: 100px"
        >
          <h1>Safe Zone</h1>
        </div>
      </div>
      <hr />
      <p>
        <center><strong>Made by Vinit Shahdeo</strong></center>
      </p>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="lib/createWaterBall-jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script>
      function getQueryStringValue(key) {
        return decodeURIComponent(
          window.location.search.replace(
            new RegExp(
              "^(?:.*[&\\?]" +
                encodeURIComponent(key).replace(/[\.\+\*]/g, "\\$&") +
                "(?:\\=([^&]*))?)?.*$",
              "i"
            ),
            "$1"
          )
        );
      }

      // Parse tank values from query string (fallback to 0)
      var x = parseInt(getQueryStringValue("tank1"), 10) || 0;
      var y = parseInt(getQueryStringValue("tank2"), 10) || 0;
      var z = parseInt(getQueryStringValue("tank3"), 10) || 0;
      var w = parseInt(getQueryStringValue("tank4"), 10) || 0;

      // Initialize tanks (attach alarm config default)
      $(".tank1").createWaterBall({ targetRange: x, alarmThreshold: 95, alarmEnabled: true });
      $(".tank2").createWaterBall({ targetRange: y, alarmThreshold: 95, alarmEnabled: true });
      $(".tank3").createWaterBall({ targetRange: z, alarmThreshold: 95, alarmEnabled: true });
      $(".tank4").createWaterBall({ targetRange: w, alarmThreshold: 95, alarmEnabled: true });

      // small loading ball (if present)
      var loadingEle = $(".loading");
      var loading_width = loadingEle.width(),
        loading_height = loadingEle.height();
      $(".loading").createWaterBall({
        cvs_config: { width: loading_width, height: loading_height },
        wave_config: { waveWidth: 0.02, waveHeight: 5 },
        data_range: [30, 70, 100],
        isLoading: true,
        nowRange: 70,
        targetRange: 70
      });
      setTimeout(function() { $(".loading").createWaterBall("updateRange", 80); }, 1000);

      // example additional ball
      $(".waterBall1").createWaterBall({
        cvs_config: { width: $(".waterBall1").width(), height: $(".waterBall1").height() },
        wave_config: { waveWidth: 0.02, waveHeight: 5 },
        data_range: [40, 50, 100],
        targetRange: 45
      });

      // Alarm sound implementation using Web Audio API (fallbacks to silent audio element)
      var alarmAudio = (function(){
        try {
          var ctx = new (window.AudioContext || window.webkitAudioContext)();
          var o = ctx.createOscillator();
          var g = ctx.createGain();
          o.type = 'sine';
          o.frequency.value = 880; // A5
          o.connect(g);
          g.connect(ctx.destination);
          g.gain.value = 0;
          o.start(0);
          return { play: function(){ g.gain.setTargetAtTime(0.2, ctx.currentTime, 0.01); }, stop: function(){ g.gain.setTargetAtTime(0, ctx.currentTime, 0.01); } };
        } catch(e) {
          var a = document.createElement('audio'); a.loop = true; return { play: function(){ try{ a.play(); }catch(e){} }, stop: function(){ try{ a.pause(); a.currentTime = 0; }catch(e){} } };
        }
      })();

      // Play alarm when any tank emits 'waterAlarm'
      $('.tank1, .tank2, .tank3, .tank4').on('waterAlarm', function(ev, nowRange, threshold){
        alarmAudio.play();
        $('#stopAlarm').addClass('btn-warning').text('Stop Alarm (Ringing)');
      });

      // Stop alarm when cleared
      $('.tank1, .tank2, .tank3, .tank4').on('waterAlarmClear', function(ev, nowRange){
        alarmAudio.stop();
        $('#stopAlarm').removeClass('btn-warning').text('Stop Alarm');
      });

      // Stop button: silence alarms in plugin instances and stop audio
      $('#stopAlarm').on('click', function(){
        $('.tank1, .tank2, .tank3, .tank4').createWaterBall('silenceAlarm');
        alarmAudio.stop();
        $(this).removeClass('btn-warning').text('Stop Alarm');
      });

      // Threshold input: update plugin instances
      function updateThreshold(v) {
        $('.tank1, .tank2, .tank3, .tank4').each(function(){
          var d = $(this).data('waterBall');
          if (!d) return;
          d.config.alarmThreshold = v;
          d.config.alarmSnoozed = false;
        });
      }

      var $threshold = $('#alarmThreshold');
      var $thresholdValue = $('#alarmThresholdValue');
      // live update while sliding
      $threshold.on('input', function(){
        var v = parseInt(this.value, 10) || 95;
        $thresholdValue.text(v + '%');
        updateThreshold(v);
      });
      // finalize on change as well
      $threshold.on('change', function(){
        var v = parseInt(this.value, 10) || 95;
        $thresholdValue.text(v + '%');
        updateThreshold(v);
      });
    </script>
  </body>
</html>
